name: Godot CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  GODOT_VERSION: "4.6"

jobs:
  lint:
    name: Lint GDScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run gdlint
        run: |
          pip install gdtoolkit
          gdlint assets/enemies/ assets/level/ static/sfx_manager.gd

  validate:
    name: Validate Project
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import project
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          godot --headless --import

      - name: Validate GDScript
        run: |
          godot --headless --check-only --script res://player/player.gd || true
          godot --headless --check-only --script res://player/weapon_manager.gd || true

  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Import project
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          godot --headless --import

      - name: Run GUT tests
        run: godot --headless -s test/run_tests.gd
        continue-on-error: true

  export-web:
    name: Export Web Build
    runs-on: ubuntu-latest
    needs: validate
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable/* ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable/ || true

      - name: Import project
        run: godot --headless --import

      - name: Create export directory
        run: mkdir -p build/web

      - name: Export to Web
        run: godot --headless --export-release "Web" build/web/index.html
        continue-on-error: true

      - name: Upload Web artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: web-build
          path: build/web
          retention-days: 14

  export-linux:
    name: Export Linux Build
    if: false  # Disabled for now
    runs-on: ubuntu-latest
    needs: validate
    container:
      image: barichello/godot-ci:4.3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable/* ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable/ || true

      - name: Import project
        run: godot --headless --import

      - name: Create export directory
        run: mkdir -p build/linux

      - name: Export to Linux
        run: godot --headless --export-release "Linux" build/linux/game.x86_64
        continue-on-error: true

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: linux-build
          path: build/linux
          retention-days: 14
